!function(){var win,doc,err,_fetch,rid,sanitize,pubsub,block;function import$(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}function in$(e,t){for(var n=-1,r=t.length>>>0;++n<r;)if(e===t[n])return 1}function import$(e,t){var n,r={}.hasOwnProperty;for(n in t)r.call(t,n)&&(e[n]=t[n]);return e}err=function(e,t){var n;return null==e&&(e=""),null==t&&(t=404),Promise.reject(((n=new Error(e)).name="lderror",n.id=t,n.message=e,n))},_fetch=function(i,e){return block.__node&&"undefined"!=typeof fs&&null!==fs&&!/^https?:/.exec(i)?new Promise(function(n,r){return fs.stat(i,function(e,t){return e?r(e):(e=t.isDirectory()?i+"/index.html":i,fs.readFile(e,function(e,t){return e?r(e):n(t.toString())}))})}):fetch(i,e).then(function(o){return o&&o.ok?o.text():o?o.clone().text().then(function(e){var t,n=o.status||404,r=n+" "+e,i=new Error(r);i.name="lderror",i.id=n,i.message=r,n=i;try{(t=JSON.parse(e))&&"lderror"===t.name&&(import$(n,t).json=t)}catch(e){0}return Promise.reject(n)}):err()})},rid=function(){for(var e;e="b-"+Math.random().toString(36).substring(2),rid.hash[e];);return rid.hash[e]=!0,e},rid.hash={},sanitize=function(e){return e||""},pubsub=function(){return this.subs={},this},pubsub.prototype=import$(Object.create(Object.prototype),{fire:function(e){for(var t,n,r=[],i=1,o=arguments.length;i<o;++i)r.push(arguments[i]);return t=r,Promise.all(((n=this.subs)[e]||(n[e]=[])).map(function(e){return e.apply(null,t)}))},on:function(e,t){var n;return((n=this.subs)[e]||(n[e]=[])).push(t)}}),block={id:function(e){var t=e.path||("js"===e.type?"index.min.js":"css"===e.type?"index.min.css":"index.html");return e.id||e.url||(e.ns?e.ns+":":"")+e.name+"@"+(e.version||"main")+":"+t},id2obj:function(e){var t,n,r;return(e=e.split(":")).length<=2?(t=e[0],n=e[1],r=e[2]):(r=e[0],t=e[1],n=e[2]),(e=/^(@?[^@]+)(?:@([^:]+))?$/.exec(t))?{ns:r,name:e[1],version:e[2],path:n}:null},env:function(e){e=[e,e.document];if(win=e[0],doc=e[1],rescope.env&&rescope.env(win),rescope.env)return csscope.env(win)},i18n:{module:{lng:"en",t:function(e,t){for(var n,r,i,o,s,c,l,a,u=Array.isArray(e)?e:[e],h=this.lng,p=0,d=u.length;p<d;++p)if(null!=(n=u[p])){for(r=n.indexOf(":"),i=n.substring(0,r),o=(n=n.substring(r+1)).split("."),s=(c=(c=this.res)[h]||(c[h]={}))[i]||(c[i]={}),l=0,a=o.length;l<a&&(r=l,s);++l)s=s[o[r]];if(s)return s}return n||e[e.length-1]},changeLanguage:function(e){return this._fire("languageChanged",this.lng=e)||"en"},addResourceBundle:function(e,t,n,r,i){var o;return((o=this.res)[e]||(o[e]={}))[t]=n},_evthdr:{},on:function(e,n){var r=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;return((t=r._evthdr)[e]||(t[e]=[])).push(n)})},off:function(e,n){var r=this;return(Array.isArray(e)?e:[e]).map(function(e){var t;if(~(t=((t=r._evthdr)[e]||(t[e]=[])).indexOf(n)))return r._evthdr[e].splice(t,1)})},_fire:function(e){for(var t,n,r,i,o=[],s=[],c=1,l=arguments.length;c<l;++c)s.push(arguments[c]);for(t=s,c=0,r=(n=this._evthdr[e]||[]).length;c<r;++c)i=n[c],o.push(i.apply(this,t));return o},res:{}},use:function(e){return this.module=e},addResourceBundle:function(e,t,n,r,i){return block.i18n.module.addResourceBundle(e,t,n,r=null==r?!0:r,i=null==i?!0:i)},changeLanguage:function(e){return block.i18n.module.changeLanguage(e)}}},Object.defineProperty(block.i18n,"language",{get:function(){return block.i18n.module.lng||block.i18n.module.language}}),block.global={csscope:{hash:{},apply:function(e){var t=this;if((e=e.filter(function(e){return!t.hash[e.id||e.url]}).map(function(e){return t.hash[e.id||e.url]=e.scope})).length)return doc.body.classList.add.apply(doc.body.classList,e)}}},block.init=proxise.once(function(){if(block._rescope)return block._rescope.init()}),block.rescope=function(){return block._rescope||(block._rescope=new rescope({global:null!=win?win:global})),block._rescope},block.csscope=function(){return block._csscope||(block._csscope=new csscope.manager),block._csscope},block.manager=function(e){var t=this;return null==e&&(e={}),this.hash={},this.proxy={},this.running={},this._ver={map:{}},this._chain=e.chain||null,this.init=proxise.once(function(){return t._init()}),this.rescope=e.rescope instanceof rescope?e.rescope:block.rescope(),this.csscope=e.csscope instanceof csscope?e.csscope:block.csscope(),e.registry&&this.registry(e.registry),this.init(),this},block.manager.prototype=import$(Object.create(Object.prototype),{_init:function(){return(this.rescope===block.rescope()?block:this.rescope).init()},id:block.id,id2obj:block.id2obj,chain:function(e){return this._chain=e},registry:function(e){var t;if(null!=(e="string"==(t=typeof e)||"function"==t||e.url||e.fetch?{lib:e,block:e}:e).lib&&(this.rescope===block.rescope()&&(this.rescope=new rescope({global:win})),this.csscope===block.csscope()&&(this.csscope=new csscope.manager),this.rescope.registry(e.lib),this.csscope.registry(e.lib)),null!=e.block&&(this._reg=e.block||"","string"==typeof this._reg&&this._reg&&"/"!==(t=this._reg)[t.length-1]))return this._reg+="/"},set:function(e){var s=this;return null==e&&(e={}),e=Array.isArray(e)?e:[e],Promise.all(e.map(function(e){var t,n=e.ns,r=e.name,i=e.version,o=e.path;return n=n||"",e=e instanceof block.class?e:e.block,((n=(t=(t=s.hash)[n]||(t[n]={}))[r]||(t[r]={}))[i]||(n[i]={}))[o||"index.html"]=e}))},_getUrl:function(e){var t=e.url,n=e.name,r=e.version,i=e.path,e=e.type;return t||(this._reg||"")+"/assets/block/"+n+"/"+(r||"main")+"/"+(i||("block"===e?"index.html":"js"===e?"index.min.js":"index.min.css"))},getUrl:function(e){var t;return e.type||(e.type="block"),"function"==typeof(t=this._reg.url||this._reg)?t(e):this._getUrl(e)},_ref:function(e){var t,n;return"function"==typeof(t=this._reg.url||this._reg)&&((n=import$({},e)).url=t(e),e=n),this._reg.fetch?this._reg.fetch(e):e.url},fetch:function(e){var t;return e.type="block",(t=this._ref(e)).then?t:t?_fetch(t,{method:"GET"}).then(function(e){return{content:e}}):err(e)},_get:function(t){var e,n,r,i,o=this,s=[t.ns||"",t.name,t.version||"main",t.path||"index.html"],c=s[0],l=s[1],a=s[2],u=s[3],h={ns:c,name:l,version:a,path:u};if(!l||!a)return err("",1015);if(u=u.replace(/\/(index\.html)?$/,""),(s=(e=this.hash)[c]||(e[c]={}))[l]||(s[l]={}),/[^0-9.]/.exec(a)&&!t.force){if(((s=this._ver.map)[c]||(s[c]={}))[l]&&this._ver.map[c][l][a]&&(i=((s=this.hash[c][l])[i=this._ver.map[c][l][a]]||(s[i]={}))[u]))return i;for(n in s=((e=this.hash)[c]||(e[c]={}))[l])if(r=s[n],semver.fit(n,a))return Promise.resolve(r[u])}return null==((s=this.hash[c][l])[a]||(s[a]={}))[u]||t.force?!0!==((s=(e=(i=this.running)[c]||(i[c]={}))[l]||(e[l]={}))[a]||(s[a]={}))[u]?(this.running[c][l][a][u]=!0,this.fetch({ns:t.ns,name:t.name,version:t.version,path:t.path}).then(function(e){var t;return e?(e.version&&(h.version!==e.version&&(((t=o._ver.map[c])[l]||(t[l]={}))[h.version]=e.version),h.version=e.version),e.content||e):e404(h)}).catch(function(e){return o._chain?o._chain.get(t):Promise.reject(e)}).then(function(e){e=new block.class((h.code=e=null==e?{}:e,h.manager=o,h));return o.set((h.block=e,h)),e}).then(function(e){return o.proxy[c][l][a][u].resolve(e),e}).finally(function(){return o.running[c][l][a][u]=!1}).catch(function(e){return o.proxy[c][l][a][u].reject(e),Promise.reject(e)})):void 0:Promise.resolve(this.hash[c][l][a][u])},from:function(e,n){return this.get(e).then(function(e){return e.create().then(function(t){return t.attach(n).then(function(){return t.interface()}).then(function(e){return{instance:t,interface:e}})})})},get:function(t){var e,c=this;return null==t&&(t={}),e=Array.isArray(t)?t:[t],Promise.all(e.map(function(e){var t,n,r=(t=[(e="string"==typeof(e=null==e?{}:e)?block.id2obj(e):e).ns||"",e.name,e.version||"main",e.path||"index.html"])[0],i=t[1],o=t[2],s=(s=t[3]).replace(/\/(index\.html)?$/,"");return((t=(n=(n=c.proxy)[r]||(n[r]={}))[i]||(n[i]={}))[o]||(t[o]={}))[s]||(c.proxy[r][i][o][s]=proxise(function(e){return c._get(e)})),c.proxy[r][i][o][s](e)})).then(function(e){return Array.isArray(t)?e:e[0]})},debundle:function(e){var n=this;return null==e&&(e={}),e=(e=Array.isArray(e)?e:[e]).map(function(t){return Promise.resolve().then(function(){var a=t.manager||n,u={},e=t.root?Promise.resolve("string"==typeof t.root?doc.querySelector(t.root):t.root):(e=t.url?_fetch(t.url,{method:"GET"}):Promise.resolve(t.code||"")).then(function(e){var t;return block.debundleNode||doc.body.appendChild(block.debundleNode=doc.createElement("div")),block.debundleNode.style.display="none",block.debundleNode.appendChild(t=doc.createElement("div")),t.innerHTML=e,t.querySelector("template")});return e.then(function(e){var n,t,r,i,o,s,c,l=[];if(e){for(t in e.content&&(e=e.content),n=[{},{}][0],Array.from(e.childNodes).map(function(e){var t;if(e.nodeType===doc.ELEMENT_NODE)return"SCRIPT"===e.nodeName?u.script=e.cloneNode(!0):"STYLE"===e.nodeName?u.style=e.cloneNode(!0):(t=e.getAttribute("block"))?n[t]=e:void 0}),u.script&&((e=doc.createElement("script")).textContent=u.script.textContent,u.script=e,u.script.import=function(e){return u.codes="function"==typeof e?e():e},u.script.setAttribute("type","text/javascript"),doc.body.appendChild(u.script)),u.style&&(u.style.setAttribute("type","text/css"),doc.body.appendChild(u.style)),n)r=n[t],c=(s=block.id2obj(t)).ns,i=s.name,o=s.version,s=s.path,c=new block.class({manager:a,ns:c,name:i,version:o,path:s,code:{script:u.codes[t],dom:r,style:""}}),l.push(a.set(c));return l}})})}),Promise.all(e)}}),block.class=function(e){var t,n,r,i,o,s,c=this;if(this.opt=e=null==e?{}:e,this.scope=e.scope||null,this._ctx={},this.csscopes={global:[],local:[]},this.ns=e.ns,this.name=e.name,this.version=e.version,this.path=e.path,this.manager=e.manager,e.ns||(e.ns=""),this.manager||console.warn("manager is mandatory when constructing block.class"),t=e.code,e.root?n="string"==typeof e.root?doc.querySelector(e.root):e.root:"string"==typeof(t="function"==typeof t?t():t)?(t=sanitize(t),(r=doc.createElement("div")).innerHTML=(t||"").trim(),this._templates=Array.from(r.querySelectorAll("template[rel=block]")).map(function(e){return e.parentNode.removeChild(e)}),1<r.childNodes.length&&console.warn("DOM definition of a block should contain only one root.")):"object"==typeof t&&(this.script=t.script,this.style=t.style,this.style=t.style,this.script=t.script,(e=t.dom instanceof Function?t.dom():t.dom)instanceof win.Element?n=e:(t=sanitize(e),(r=doc.createElement("div")).innerHTML=t,1<r.childNodes.length&&console.warn("DOM definition of a block should contain only one root."))),["script","style","link"].map(function(e){var t=Array.from((n||r).querySelectorAll(e)).map(function(e){return e.parentNode.removeChild(e),e.textContent}).join("\n");return c[e]=null!=t&&t?t:c[e]||""}),!n&&r)for(i=0,o=r.childNodes.length;i<o&&(s=i,(n=r.childNodes[s]).nodeType!==win.Element.ELEMENT_NODE);++i);return(n=n||doc.createElement("div")).nodeType!==win.Element.ELEMENT_NODE&&console.warn("root of DOM definition of a block should be an Element"),this.node=n,this.init=proxise.once(function(){return c._init()}),this},block.class.prototype=import$(Object.create(Object.prototype),{_init:function(){var this$=this;return block.init().then(function(){if(this$._templates)return Promise.all(this$._templates.map(function(e){return this$.manager.debundle({root:e})}))}).then(function(){var v,ref$,ret;return this$.interface=this$.script instanceof Function?this$.script():"object"==typeof this$.script?this$.script:(v=eval("(function(module){"+(this$.script||"")+";return module.exports;})({})"))instanceof Function?v():v||{},this$.interface||(this$.interface={}),(ref$=this$.interface).pkg||(ref$.pkg={}),this$.name||(this$.name=this$.interface.pkg.name),this$.version||(this$.version=this$.interface.pkg.version),this$.path||(this$.path=this$.interface.pkg.path),this$.id=block.id({ns:this$.ns,name:this$.name||rid(),version:this$.version||rid(),path:this$.path}),this$._id_t=this$.id.replace(/:/g,"="),this$.scope||(this$.scope=csscope.scope(this$)),this$.style&&(doc.body.appendChild(this$.styleNode=doc.createElement("style")),this$.styleNode.setAttribute("type","text/css"),ret=csscope({rule:"*[scope~="+this$.scope+"]",name:this$.scope,css:this$.style,scopeTest:"[scope]"}),ret=ret.replace(/url\("?(?!data:)([^()"]+)"?\)/g,"url("+this$._path("")+"$1)"),this$.styleNode.textContent=ret),this$.factory=function(e){return this._instance=e,this},this$.factory.prototype=import$((ref$=Object.create(Object.prototype),ref$.init=function(){},ref$.destroy=function(){},ref$._class=this$,ref$.interface=function(){if(this.parent)return this.parent.interface instanceof Function?this.parent.interface():this.parent.interface},ref$),this$.interface)}).then(function(){var e;if(this$.extends=[],e=this$.interface.pkg.extend)return this$.manager?(e.name||e.url||(e.ns=this$.ns,e.name=this$.name,e.version=this$.version),this$.manager.get(e).then(function(t){this$.extend=t;try{this$.extend._usedby(this$)}catch(e){throw t=e,this$.extend=null,t}return this$.extendDom=!(null!=e.dom)||e.dom,this$.extendStyle=!(null!=e.style)||e.style,this$.extend.init()}).then(function(){return this$.extends=[this$.extend].concat(this$.extend.extends)})):new Error("no available manager to get extended block")}).then(function(){var e,t,n=[],r=this$.interface.pkg.i18n||{};for(e in r)t=r[e],n.push(block.i18n.module.addResourceBundle(e,this$._id_t,t,!0,!0));return n}).then(function(){var n,r;return this$.dependencies=Array.isArray(this$.interface.pkg.dependencies)?this$.interface.pkg.dependencies:function(){var e,t=[];for(n in e=this.interface.pkg.dependencies||{})r=e[n],t.push(r);return t}.call(this$),this$.dependencies.map(function(e){if(e.name||e.url||(e.ns=this$.ns,e.name=this$.name,e.version=this$.version),!e.type)return!/\.js$/.exec(e.url||e.path||e)&&/\.css$/.exec(e.url||e.path||e)?e.type="css":e.type="js"}),this$.extend?this$._ctx=this$.extend.context():rescope.dualContext?this$._ctx=rescope.dualContext():rescope.proxin&&(this$._ctx=new rescope.proxin),this$.manager.rescope.load(this$.dependencies.filter(function(e){return!e.type||"js"===e.type}),this$._ctx)}).then(function(){return this$.manager.csscope.load(this$.dependencies.filter(function(e){return"css"===e.type&&!0===e.global}))}).then(function(e){return this$.csscopes.global=e||[],this$.manager.csscope.load(this$.dependencies.filter(function(e){return"css"===e.type&&!0!==e.global}))}).then(function(e){if(this$.csscopes.local=e||[],this$.extend)return(e=this$.csscopes).global=e.global.concat(this$.extend.csscopes.global||[]),!0===this$.extendStyle?(e=this$.csscopes).local=e.local.concat(this$.extend.csscopes.local||[]):"overwrite"===this$.extendDom?(e=this$.csscopes).local=e.local.concat(this$.extend.csscopes.local.slice(1)):void 0}).catch(function(e){return console.error("[@plotdb/block] init "+block.id(this$),e),this$.interface={},this$.styleNode={},this$.factory=function(){return this},this$.dependencies=[],this$})},_usedby:function(e){var o,s=this;if(this===e)throw new Error("circular extend");return(this._users||(this._users=[])).push(e),(o=function(e){var t,n,r,i=[];if(in$(s,e=null==e?[]:e))throw new Error("circular extend");for(t=0,n=e.length;t<n;++t)r=e[t],i.push(o(r._users));return i})(e._users)},context:function(){return this._ctx},dom:function(){return this.node},_path:function(e){return null==e&&(e=""),this.manager.getUrl({ns:this.ns,name:this.name,version:this.version,path:this.path}).replace(/\/[^/]*$/,"/")+e},i18n:function(t,e){var n=this._id_t;return block.i18n.module.t([n+":"+t].concat(this.extends.map(function(e){return e._id_t+":"+t}),[t+""]),e)},create:function(t){var n=this;return null==t&&(t={}),this.init().then(function(){var e=new block.instance({block:n,ns:n.ns,name:n.name,path:n.path,version:n.version,data:t.data});return e.init().then(function(){if(t.root)return e.attach({root:t.root,before:t.before,autoTransform:t.autoTransform||null})}).then(function(){return e})})},resolvePlugAndCloneNode:function(n,e){var t;return(e=null==e?!1:e)?t=n:(t=this.dom().cloneNode(!0),n&&Array.from(t.querySelectorAll("plug")).map(function(e){var t=e.getAttribute("name"),t=n.querySelector(":scope :not([plug]) [plug="+t+"], :scope > [plug="+t+"]");if(t)return e.replaceWith(t)})),this.extend&&!1!==this.extendDom?"overwrite"===this.extendDom?this.extend.resolvePlugAndCloneNode(t,!0):this.extend.resolvePlugAndCloneNode(t):t}}),block.instance=function(e){var t=this;return this.ns=(e=null==e?{}:e).ns,this.name=e.name,this.version=e.version,this.path=e.path,this.block=e.block,this.data=e.data,this.init=proxise.once(function(){return t._init()}),this},block.instance.prototype=import$(Object.create(Object.prototype),{_init:function(){return this.block.init()},attach:function(e){var t,n,r,i,o,s,c,l,a=this;if(null==e&&(e={}),t=this._defered)return t.before?t.root.insertBefore(t.node,t.before):t.root.appendChild(t.node),Promise.resolve();if(e.data&&(this.data=e.data),t=(t=e.root)?"string"==typeof t?doc.querySelector(t):t:null,block.global.csscope.apply(this.block.csscopes.global),t){for(n=this.dom(e.root),r=[this.block].concat(this.block.extends),i=[this.block.scope],o=0,s=r.length-1;o<s;++o)if("overwrite"!==(l=r[c=o].extendStyle)){if(!1===l)break;i.push(r[c+1].scope)}n.setAttribute("scope",i.join(" ")),n.classList.add.apply(n.classList,this.block.csscopes.local.map(function(e){return e.scope}).concat(this.block.csscopes.global.map(function(e){return e.scope}))),e.defer?this._defered={node:n,root:t,before:e.before}:e.before?t.insertBefore(n,e.before):t.appendChild(n)}else n=null;return"i18n"===e.autoTransform&&block.i18n.module.on("languageChanged",this._i18nTransform=function(){return a.transform("i18n")}),this.run({node:n,type:"init"})},detach:function(){var e=this.dom();return e.parentNode.removeChild(e),this._i18nTransform&&(block.i18n.module.off("languageChanged",this._i18nTransform),this._i18nTransform=null),this.run({node:e,type:"destroy"})},interface:function(){var e;return(e=this.obj)[e.length-1].interface()},_transform:function(e,l,a){var u=new RegExp("^"+l+"-(.+)$"),h=function(e){var t,n,r,i,o,s,c=[];if(e.nodeType===win.Element.TEXT_NODE)return e.parentNode.setAttribute(l,e.textContent),e.parentNode.replaceChild(doc.createTextNode(a(e.textContent)),e);for(t=0,n=e.attributes.length;t<n;++t)r=t,o=(i=e.attributes[r]).name,i=i.value,(o=u.exec(o))&&e.setAttribute(o[1],a(i||""));if(s=e.getAttribute(l))return e.textContent=a(s);for(t=0,n=e.childNodes.length;t<n;++t)r=t,c.push(h(e.childNodes[r]));return c},t=new WeakMap;return Array.from(e.querySelectorAll(":scope [scope] ["+l+"]")).map(function(e){return t.set(e,1)}),Array.from(e.querySelectorAll("["+l+"]")).filter(function(e){return!t.get(e)}).map(h),e},transform:function(e){var t=this;if("i18n"===e||"path"===e)return this._transform(this.node,"t",function(e){return t.i18n(e)}),this._transform(this.node,"path",function(e){return t._path(e)})},dom:function(e){var t;return(t=this.node)||(this.node=this.block.resolvePlugAndCloneNode(e),this.transform("i18n"),this.transform("path"))},_path:function(e){return this.block._path(e)},i18n:function(e,t){return this.block.i18n(e,t)},run:function(e){var p=this,d=e.node,f=e.type,t=[],m=[],n=this.block;for(this.obj||(this.obj=[]),this.pubsub||(this.pubsub=new pubsub);n;)t=[n].concat(t),n=n.extend;return new Promise(function(a,u){var h=function(e,t,n,r,i){var o,s,c,l;return null==t&&(t=0),null==n&&(n={}),(e=null==e?[]:e).length<=t?Promise.all(m).then(function(e){return a(e)}).catch(function(e){return u(e)}):(o=e[t],s=o._ctx.ctx?o._ctx.ctx():(s=o._ctx).local||(s.local={}),import$(n,s),s={root:d,parent:r,manager:p.block.manager,ctx:n,context:n,pubsub:p.pubsub,i18n:{getLanguage:function(){return block.i18n.language},addResourceBundles:function(e){var t,n,r=[];for(t in e=null==e?{}:e)n=e[t],r.push(block.i18n.addResourceBundle(t,p.block._id_t,n));return r},t:function(e,t){return p.block.i18n(e,t)}},t:function(e,t){return p.block.i18n(e,t)},path:function(e){return p._path(e)},data:p.data},"init"===f&&(p.obj.push(c=new o.factory(p.block===o?p:null)),c.parent=p.obj[t-1]),(c=p.obj[t])&&m.push(l=c[f](s)),o.interface.pkg.syncInit&&l?Promise.resolve(l).then(function(){return h(e,t+1,n,c)}):h(e,t+1,n,c))};return h(t,0,{})})}}),block.manager.prototype.bundle=function(opt){var mgr,hash,_;return null==opt&&(opt={}),mgr=opt.manager||this,hash={},_=function(list,blocks,deps){var bd,id;return(null==blocks&&(blocks=[]),null==deps&&(deps={js:[],css:[],block:[]}),list.length)?(bd=JSON.parse(JSON.stringify(list.splice(0,1)[0])),bd.path=(bd.path||"").replace(/\/(index\.html)?$/,""),id=block.id(bd),hash[id]?Promise.resolve().then(function(){return _(list,blocks,deps)}):_fetch(mgr.getUrl(bd),{method:"GET"}).then(function(it){var node,css,js,ret,ref$,b;return deps.block.push(bd),node=doc.createElement("div"),node.innerHTML=(it||"").trim(),1<node.childNodes.length&&console.warn("DOM definition of a block should contain only one root."),css="",js=["script"].map(function(e){return Array.from(node.querySelectorAll(e)).map(function(e){return e.parentNode.removeChild(e),e.textContent}).join("\n")})[0],node.childNodes[0].setAttribute("block",id),ret=eval("(function(module){"+(js||"")+";return module.exports;})({})"),ret instanceof Function&&(ret=ret()),ret=ret||{},ret.pkg||(ret.pkg={}),(ref$=ret.pkg).dependencies||(ref$.dependencies=[]),ret.pkg.extend&&(ret.pkg.extend.name||(ref$=ret.pkg.extend,ref$.ns=bd.ns,ref$.name=bd.name,ref$.version=bd.version),list.push(ret.pkg.extend)),ret.pkg.dependencies.map(function(e){if(e.name||(e.ns=bd.ns,e.name=bd.name,e.version=bd.version),!e.type)return!/\.js$/.exec(e.url||e.path||e)&&/\.css$/.exec(e.url||e.path||e)?e.type="css":e.type="js"}),deps.js=deps.js.concat((ret.pkg.dependencies||[]).filter(function(e){return"js"===e.type||/\.js/.exec(e.path||e||"")})),deps.css=deps.css.concat((ret.pkg.dependencies||[]).filter(function(e){return"css"===e.type||/\.css/.exec(e.path||e||"")})),js="((function(module){"+(js||"")+";return module.exports;})({}))",blocks.push(b={js:js,css:css,html:node.innerHTML,bd:bd,id:id}),list=list.concat((ret.pkg.dependencies||[]).filter(function(e){return"block"===e.type||/\.html/.exec(e.path||e||"")})),hash[id]=b,_(list,blocks,deps)})):Promise.resolve({blocks:blocks,deps:deps})},_((opt.blocks||(opt.blocks=[])).map(function(e){return e})).then(function(e){var i=e.blocks,o=e.deps;return Promise.all([mgr.csscope.bundle(o.css),mgr.rescope.bundle(o.js)]).then(function(e){var t,n=e[0],e=e[1],r=i.map(function(e){return'"'+e.id+'":'+(e.js||'""')});return r="document.currentScript.import({"+r.join(",")+"});",t=o.css.map(function(e){var t=import$({},e);return t.inited=!0,t.scope=csscope.scope(e),delete(e=t).code,"csscope.cache("+JSON.stringify(e)+")"}).join(";"),{code:['<template rel="block">',i.map(function(e){return e.html||""}).join(""),'<style type="text/css">'+n+"</style>",'<script type="text/javascript">'+r+e+";"+t+"<\/script>","</template>"].join(""),deps:o}})})},block.env("undefined"!=typeof self&&null!==self?self:globalThis),"undefined"!=typeof module&&null!==module?module.exports=block:"undefined"!=typeof window&&null!==window&&(window.block=block)}();
